<!--
    This static header occurs across every CMS-built page, and includes extra
    JS dependencies, along with a MarkdownPage component
-->

<!-- Set up a markdown function, using showdown -->
<script Configuration -src="https://unpkg.com/showdown/dist/showdown.min.js">
    function getMarkdownData(source) {
        const converter = new showdown.Converter({ metadata: true });
        const html = converter.makeHtml(source);
        const data = converter.getMetadata();
        data.body = Object.assign(String(html), { safe: true });
        return data;
    }
    modulo.register('util', getMarkdownData);
</script>

<!-- Load the base components as well -->
<Library namespace="x" -src="/static/"></Library>
<Component namespace="cms" name="MarkdownPage" mode="vanish-into-document">
    <Template -src="./MarkdownPage/MarkdownPage.html"></Template>
    <Script -name="page">
        function prepareCallback(renderObj) {
            const { originalHTML } = element;
            // Unescape (fixes issues with using HTML as source file)
            const source = originalHTML.replace(/&gt;/gi, '>').replace(/&lt;/gi, '<');
            return modulo.registry.utils.getMarkdownData(source);
        }
    </Script>
</Component>
